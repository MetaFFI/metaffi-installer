name: Manual Build + Installers

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Installer version (for artifact/release names)"
        required: true
        type: string
      metaffi_root_ref:
        description: "metaffi-root git ref (branch/tag/sha)"
        required: true
        default: "main"
        type: string
      build_type:
        description: "CMake build type"
        required: true
        default: "Release"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
      publish:
        description: "Publish release assets"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows + CTests + Installer
    runs-on: windows-2022
    steps:
      - name: Checkout metaffi-installer
        uses: actions/checkout@v4

      - name: Restore Windows vcpkg cache artifact
        uses: dawidd6/action-download-artifact@v9
        with:
          workflow: manual-build-installers.yml
          branch: main
          name: vcpkg-cache-windows
          path: vcpkg-cache
          search_artifacts: true
          if_no_artifact_found: warn

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup vcpkg
        shell: pwsh
        run: |
          $desiredVcpkgRoot = "C:\vcpkg"
          if(Test-Path $desiredVcpkgRoot){
            Remove-Item -Path $desiredVcpkgRoot -Recurse -Force
          }
          git clone https://github.com/microsoft/vcpkg.git $desiredVcpkgRoot
          & "$desiredVcpkgRoot\bootstrap-vcpkg.bat"
          & "$desiredVcpkgRoot\vcpkg.exe" version

          $cacheRoot = "$env:GITHUB_WORKSPACE\vcpkg-cache"
          if(Test-Path "$cacheRoot\installed"){
            Write-Host "Restoring cached vcpkg installed tree..."
            New-Item -ItemType Directory -Path "$desiredVcpkgRoot\installed" -Force | Out-Null
            Copy-Item -Path "$cacheRoot\installed\*" -Destination "$desiredVcpkgRoot\installed" -Recurse -Force
          }
          if(Test-Path "$cacheRoot\downloads"){
            Write-Host "Restoring cached vcpkg downloads tree..."
            New-Item -ItemType Directory -Path "$desiredVcpkgRoot\downloads" -Force | Out-Null
            Copy-Item -Path "$cacheRoot\downloads\*" -Destination "$desiredVcpkgRoot\downloads" -Recurse -Force
          }
          if(Test-Path "$cacheRoot\vcpkg-packages.txt"){
            Copy-Item -Path "$cacheRoot\vcpkg-packages.txt" -Destination "$env:GITHUB_WORKSPACE\vcpkg-prev-packages.txt" -Force
          }

          # Force consistent vcpkg root to avoid VS runner default mismatch warnings.
          $env:VCPKG_ROOT = $desiredVcpkgRoot
          "VCPKG_ROOT=$desiredVcpkgRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $desiredVcpkgRoot | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Clone metaffi-root
        shell: pwsh
        run: |
          git clone https://github.com/MetaFFI/metaffi-root.git metaffi-root
          git -C metaffi-root fetch --all --tags
          git -C metaffi-root checkout "${{ inputs.metaffi_root_ref }}"

      - name: Configure CMake
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "C:\vcpkg"
          $env:METAFFI_SOURCE_ROOT = "$env:GITHUB_WORKSPACE\metaffi-root"
          $env:METAFFI_HOME = "$env:GITHUB_WORKSPACE\metaffi-root\output\windows\x64\${{ inputs.build_type }}"
          cmake -S "$env:GITHUB_WORKSPACE\metaffi-root" -B "$env:GITHUB_WORKSPACE\metaffi-root\cmake-build-${{ inputs.build_type }}" -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" -DCMAKE_TOOLCHAIN_FILE="C:\vcpkg\scripts\buildsystems\vcpkg.cmake" -DVCPKG_ROOT="C:\vcpkg"

      - name: Capture Windows vcpkg package list
        if: success()
        shell: pwsh
        run: |
          & "C:\vcpkg\vcpkg.exe" list | Sort-Object | Out-File -FilePath "$env:GITHUB_WORKSPACE\vcpkg-current-packages.txt" -Encoding utf8

      - name: Compare Windows vcpkg package list
        if: success()
        shell: pwsh
        run: |
          $prev = "$env:GITHUB_WORKSPACE\vcpkg-prev-packages.txt"
          $curr = "$env:GITHUB_WORKSPACE\vcpkg-current-packages.txt"
          $unchanged = $true
          if(Test-Path $prev){
            $unchanged = ((Get-Content $prev -Raw) -eq (Get-Content $curr -Raw))
          }
          "VCPKG_WINDOWS_CACHE_UNCHANGED=$($unchanged.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          if(-not $unchanged){
            Write-Warning "vcpkg package list changed; skipping cache upload."
          }

      - name: Prepare Windows vcpkg cache artifact
        if: success() && env.VCPKG_WINDOWS_CACHE_UNCHANGED == 'true'
        shell: pwsh
        run: |
          $outputDir = "$env:GITHUB_WORKSPACE\vcpkg-cache-upload"
          if(Test-Path $outputDir){
            Remove-Item -Path $outputDir -Recurse -Force
          }
          New-Item -ItemType Directory -Path "$outputDir\installed" -Force | Out-Null
          New-Item -ItemType Directory -Path "$outputDir\downloads" -Force | Out-Null
          if(Test-Path "C:\vcpkg\installed"){
            Copy-Item -Path "C:\vcpkg\installed\*" -Destination "$outputDir\installed" -Recurse -Force
          }
          if(Test-Path "C:\vcpkg\downloads"){
            Copy-Item -Path "C:\vcpkg\downloads\*" -Destination "$outputDir\downloads" -Recurse -Force
          }
          Copy-Item -Path "$env:GITHUB_WORKSPACE\vcpkg-current-packages.txt" -Destination "$outputDir\vcpkg-packages.txt" -Force

      - name: Upload Windows vcpkg cache artifact
        if: success() && env.VCPKG_WINDOWS_CACHE_UNCHANGED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-cache-windows
          path: vcpkg-cache-upload
          if-no-files-found: error

      - name: Build MetaFFI
        shell: pwsh
        run: cmake --build "$env:GITHUB_WORKSPACE\metaffi-root\cmake-build-${{ inputs.build_type }}" --target MetaFFI --config "${{ inputs.build_type }}"

      - name: Run CTests (fail-fast gate)
        shell: pwsh
        run: ctest --test-dir "$env:GITHUB_WORKSPACE\metaffi-root\cmake-build-${{ inputs.build_type }}" -C "${{ inputs.build_type }}" --output-on-failure

      - name: Build Windows installer
        shell: pwsh
        run: |
          $env:METAFFI_WIN_HOME = "$env:GITHUB_WORKSPACE\metaffi-root\output\windows\x64\${{ inputs.build_type }}"
          python .\build_installer.py --target windows --version "${{ inputs.version }}" --output-name "metaffi-installer-${{ inputs.version }}-windows"

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: metaffi-installer-windows
          path: installers_output/metaffi-installer-${{ inputs.version }}-windows.exe
          if-no-files-found: error

  build-ubuntu:
    name: Build Ubuntu + CTests + Installer
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout metaffi-installer
        uses: actions/checkout@v4

      - name: Restore Ubuntu vcpkg cache artifact
        uses: dawidd6/action-download-artifact@v9
        with:
          workflow: manual-build-installers.yml
          branch: main
          name: vcpkg-cache-ubuntu
          path: vcpkg-cache
          search_artifacts: true
          if_no_artifact_found: warn

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build python3-pip python3-dev

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git "$GITHUB_WORKSPACE/vcpkg"
          "$GITHUB_WORKSPACE/vcpkg/bootstrap-vcpkg.sh"
          if [ -d "$GITHUB_WORKSPACE/vcpkg-cache/installed" ]; then
            echo "Restoring cached vcpkg installed tree..."
            mkdir -p "$GITHUB_WORKSPACE/vcpkg/installed"
            cp -a "$GITHUB_WORKSPACE/vcpkg-cache/installed/." "$GITHUB_WORKSPACE/vcpkg/installed/"
          fi
          if [ -d "$GITHUB_WORKSPACE/vcpkg-cache/downloads" ]; then
            echo "Restoring cached vcpkg downloads tree..."
            mkdir -p "$GITHUB_WORKSPACE/vcpkg/downloads"
            cp -a "$GITHUB_WORKSPACE/vcpkg-cache/downloads/." "$GITHUB_WORKSPACE/vcpkg/downloads/"
          fi
          if [ -f "$GITHUB_WORKSPACE/vcpkg-cache/vcpkg-packages.txt" ]; then
            cp "$GITHUB_WORKSPACE/vcpkg-cache/vcpkg-packages.txt" "$GITHUB_WORKSPACE/vcpkg-prev-packages.txt"
          fi
          echo "VCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg" >> "$GITHUB_ENV"
          echo "$GITHUB_WORKSPACE/vcpkg" >> "$GITHUB_PATH"

      - name: Clone metaffi-root
        run: |
          git clone https://github.com/MetaFFI/metaffi-root.git metaffi-root
          git -C metaffi-root fetch --all --tags
          git -C metaffi-root checkout "${{ inputs.metaffi_root_ref }}"

      - name: Configure CMake
        run: |
          export METAFFI_SOURCE_ROOT="$GITHUB_WORKSPACE/metaffi-root"
          export METAFFI_HOME="$GITHUB_WORKSPACE/metaffi-root/output/linux/x64/${{ inputs.build_type }}"
          cmake -S "$GITHUB_WORKSPACE/metaffi-root" -B "$GITHUB_WORKSPACE/metaffi-root/cmake-build-${{ inputs.build_type }}" -DCMAKE_BUILD_TYPE="${{ inputs.build_type }}" -DCMAKE_TOOLCHAIN_FILE="$GITHUB_WORKSPACE/vcpkg/scripts/buildsystems/vcpkg.cmake"

      - name: Capture Ubuntu vcpkg package list
        if: success()
        run: |
          "$GITHUB_WORKSPACE/vcpkg/vcpkg" list | sort > "$GITHUB_WORKSPACE/vcpkg-current-packages.txt"

      - name: Compare Ubuntu vcpkg package list
        if: success()
        run: |
          cache_unchanged=true
          if [ -f "$GITHUB_WORKSPACE/vcpkg-prev-packages.txt" ]; then
            if ! cmp -s "$GITHUB_WORKSPACE/vcpkg-prev-packages.txt" "$GITHUB_WORKSPACE/vcpkg-current-packages.txt"; then
              cache_unchanged=false
            fi
          fi
          echo "VCPKG_UBUNTU_CACHE_UNCHANGED=$cache_unchanged" >> "$GITHUB_ENV"
          if [ "$cache_unchanged" != "true" ]; then
            echo "::warning::vcpkg package list changed; skipping cache upload."
          fi

      - name: Prepare Ubuntu vcpkg cache artifact
        if: success() && env.VCPKG_UBUNTU_CACHE_UNCHANGED == 'true'
        run: |
          rm -rf "$GITHUB_WORKSPACE/vcpkg-cache-upload"
          mkdir -p "$GITHUB_WORKSPACE/vcpkg-cache-upload/installed"
          mkdir -p "$GITHUB_WORKSPACE/vcpkg-cache-upload/downloads"
          if [ -d "$GITHUB_WORKSPACE/vcpkg/installed" ]; then
            cp -a "$GITHUB_WORKSPACE/vcpkg/installed/." "$GITHUB_WORKSPACE/vcpkg-cache-upload/installed/"
          fi
          if [ -d "$GITHUB_WORKSPACE/vcpkg/downloads" ]; then
            cp -a "$GITHUB_WORKSPACE/vcpkg/downloads/." "$GITHUB_WORKSPACE/vcpkg-cache-upload/downloads/"
          fi
          cp "$GITHUB_WORKSPACE/vcpkg-current-packages.txt" "$GITHUB_WORKSPACE/vcpkg-cache-upload/vcpkg-packages.txt"

      - name: Upload Ubuntu vcpkg cache artifact
        if: success() && env.VCPKG_UBUNTU_CACHE_UNCHANGED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-cache-ubuntu
          path: vcpkg-cache-upload
          if-no-files-found: error

      - name: Build MetaFFI
        run: cmake --build "$GITHUB_WORKSPACE/metaffi-root/cmake-build-${{ inputs.build_type }}" --target MetaFFI --config "${{ inputs.build_type }}"

      - name: Run CTests (fail-fast gate)
        run: ctest --test-dir "$GITHUB_WORKSPACE/metaffi-root/cmake-build-${{ inputs.build_type }}" -C "${{ inputs.build_type }}" --output-on-failure

      - name: Build Ubuntu installer
        run: |
          export METAFFI_UBUNTU_HOME="$GITHUB_WORKSPACE/metaffi-root/output/linux/x64/${{ inputs.build_type }}"
          python3 ./build_installer.py --target ubuntu --version "${{ inputs.version }}" --output-name "metaffi-installer-${{ inputs.version }}-ubuntu"

      - name: Upload Ubuntu installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: metaffi-installer-ubuntu
          path: installers_output/metaffi-installer-${{ inputs.version }}-ubuntu
          if-no-files-found: error

  combine-installers:
    name: Build Combined Installer
    runs-on: ubuntu-22.04
    needs: [build-windows, build-ubuntu]
    steps:
      - name: Checkout metaffi-installer
        uses: actions/checkout@v4

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: metaffi-installer-windows
          path: dist

      - name: Download Ubuntu installer artifact
        uses: actions/download-artifact@v4
        with:
          name: metaffi-installer-ubuntu
          path: dist

      - name: Build combined installer
        run: |
          python3 ./build_combined_installer.py \
            --windows-installer "./dist/metaffi-installer-${{ inputs.version }}-windows.exe" \
            --ubuntu-installer "./dist/metaffi-installer-${{ inputs.version }}-ubuntu" \
            --version "${{ inputs.version }}" \
            --output "./dist/metaffi-installer-${{ inputs.version }}"

      - name: Upload combined installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: metaffi-installer-combined
          path: dist/metaffi-installer-${{ inputs.version }}
          if-no-files-found: error

  publish-release:
    name: Publish Release Assets
    if: ${{ inputs.publish }}
    runs-on: ubuntu-22.04
    needs: [build-windows, build-ubuntu, combine-installers]
    steps:
      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: metaffi-installer-windows
          path: dist

      - name: Download Ubuntu installer artifact
        uses: actions/download-artifact@v4
        with:
          name: metaffi-installer-ubuntu
          path: dist

      - name: Download combined installer artifact
        uses: actions/download-artifact@v4
        with:
          name: metaffi-installer-combined
          path: dist

      - name: Publish release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version }}"
          TAG="v${VERSION}"
          gh release view "${TAG}" >/dev/null 2>&1 || gh release create "${TAG}" --title "MetaFFI ${VERSION}" --notes "Manual CI build"
          gh release upload "${TAG}" \
            "./dist/metaffi-installer-${VERSION}-windows.exe" \
            "./dist/metaffi-installer-${VERSION}-ubuntu" \
            "./dist/metaffi-installer-${VERSION}" \
            --clobber
